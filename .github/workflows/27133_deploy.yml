# Ime delovnega procesa
name: Deploy

# Okoljske spremenljivke uporabljene v delovnem procesu
env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }} # Uporabniško ime za Docker Hub
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }} # Geslo za Docker Hub
  REPONAME: ${{ secrets.REPO_NAME }} # Ime repozitorija na Docker Hub-u

# Dogodki, ki sprožijo delovni proces
on:
  workflow_run:
    workflows: ["Test workflow"] # Imena delovnih tokov, ki ob uspehu sprožijo ta delovni tok
    types:
      - completed # Ta delovni tok se sproži, ko je prejšnji delovni tok zaključen

# Opravila, ki se izvajajo v tem delovnem procesu
jobs:
  deploy:
    runs-on: self-hosted # Opravilo se izvede na samo-gostiteljskem strežniku
    if: ${{ github.event.workflow_run.conclusion == 'success' }} # Pogoj za izvedbo, preveri uspeh prejšnjega delovnega toka
    steps:
      - name: Checkout repozitorija
        uses: actions/checkout@v2 # Pridobivanje kode iz repozitorija

      - name: Prijava v Docker
        run: |
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin # Prijava v Docker Hub

      - name: Trenutni čas
        run: echo "date=$(date +'%Y-%m-%d--%H-%M-%S')" >> "$GITHUB_ENV" # Shrani trenutni čas v okoljsko spremenljivko 'date'

      - name: Zgradi docker sliko
        run: |
          docker build . --file Dockerfile --tag $DOCKER_USERNAME/$REPONAME:${{ env.date }} # Gradnja Docker slike s tagom, ki vsebuje trenutni čas

      - name: Potisni docker sliko
        run: |
          docker push $DOCKER_USERNAME/$REPONAME:${{ env.date }} # Potisni Docker sliko v Docker Hub repozitorij
